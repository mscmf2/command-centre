<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Command Centre - Modular System</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#F5F2ED; --surface:#FDFBF8; --surface2:#F0EDE8; --border:#E2DDD6;
  --text:#1A1714; --text-muted:#8A8178;
  --accent:#2C5F2E; --accent-light:#E8F0E8;
  --warn:#B8540A; --warn-light:#FEF3E8;
  --danger:#A8200D; --danger-light:#FDECEA;
  --blue:#1B4F8A; --blue-light:#E8EFF8;
  --purple:#5B3A8C; --purple-light:#F0EAF8;
  --yellow:#FFC107; --yellow-light:#FFF9E6;
  --gray:#8A8178; --gray-light:#F0EDE8;
}
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; font-size:14px; }

header { background:var(--text); color:white; padding:0 32px; display:flex; align-items:center; justify-content:space-between; height:60px; position:sticky; top:0; z-index:100; }
.header-brand { font-family:'DM Serif Display',serif; font-size:20px; }
.header-right { display:flex; align-items:center; gap:12px; }

.user-selector select {
  background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:white;
  padding:6px 30px 6px 12px; border-radius:6px; font-size:13px; cursor:pointer; appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:right 10px center;
}

.sync-status { font-size:11px; color:rgba(255,255,255,0.45); display:flex; align-items:center; gap:5px; }
.sync-dot { width:6px; height:6px; border-radius:50%; background:#4CAF50; }
.sync-dot.syncing { background:#FFA726; animation:pulse 1s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

.btn-add { background:var(--accent); color:white; border:none; padding:8px 16px; border-radius:6px; font-size:13px; font-weight:500; cursor:pointer; }
.btn-add:hover { background:#224a24; }

.config-banner { background:#FFF8E1; border-bottom:1px solid #FFE082; padding:12px 32px; display:flex; align-items:center; gap:12px; font-size:13px; }
.config-banner.hidden { display:none; }
.config-banner input { flex:1; max-width:560px; padding:7px 12px; border:1px solid #FFD54F; border-radius:6px; font-size:13px; }
.btn-connect { background:#F57F17; color:white; border:none; padding:7px 16px; border-radius:6px; font-size:13px; cursor:pointer; }

main { padding:28px 32px; max-width:1400px; margin:0 auto; }

.summary-bar { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:28px; }
.summary-card { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:16px 18px; cursor:pointer; transition:box-shadow 0.12s; }
.summary-card:hover { box-shadow:0 2px 8px rgba(0,0,0,0.07); }
.summary-num { font-family:'DM Serif Display',serif; font-size:32px; line-height:1; margin-bottom:4px; }
.summary-label { font-size:12px; color:var(--text-muted); }

.filters { display:flex; gap:6px; margin-bottom:20px; flex-wrap:wrap; }
.filter-chip { padding:5px 12px; border-radius:20px; border:1px solid var(--border); background:var(--surface); font-size:12.5px; cursor:pointer; transition:all 0.12s; color:var(--text-muted); }
.filter-chip:hover { border-color:#bbb; color:var(--text); }
.filter-chip.active { background:var(--text); border-color:var(--text); color:white; font-weight:500; }

.task-row {
  display:grid;
  grid-template-columns:32px 60px 1fr 150px 180px 120px;
  align-items:center;
  padding:10px 12px;
  border-radius:7px;
  border:1px solid var(--border);
  transition:all 0.12s;
  background:var(--surface);
  margin-bottom:4px;
  cursor:pointer;
}
.task-row:hover { box-shadow:0 1px 6px rgba(0,0,0,0.07); border-color:#d0ccc7; }
.task-row.done { opacity:0.5; }

.task-check { width:18px; height:18px; border-radius:4px; border:1.5px solid var(--border); cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.12s; }
.task-check:hover { border-color:var(--accent); }
.task-check.checked { background:var(--accent); border-color:var(--accent); color:white; font-size:11px; }

.priority-badge { padding:2px 8px; border-radius:12px; font-size:10px; font-weight:600; display:inline-block; }
.priority-P1 { background:#FDECEA; color:#A8200D; }
.priority-P2 { background:#FEF3E8; color:#B8540A; }
.priority-P3 { background:#FFF9E6; color:#FFC107; }
.priority-P4 { background:#F0EDE8; color:#8A8178; }

.task-content { display:flex; flex-direction:column; gap:2px; }
.task-name { font-size:13.5px; font-weight:500; }
.task-meta { font-size:11px; color:var(--text-muted); display:flex; gap:8px; align-items:center; }
.task-meta-item { display:flex; align-items:center; gap:3px; }

.task-assignee { font-size:12.5px; color:var(--text); }
.task-dept { font-size:12px; color:var(--text-muted); }
.task-due { font-size:12.5px; color:var(--text-muted); }
.task-due.overdue { color:var(--danger); font-weight:500; }

.task-actions { display:flex; gap:4px; justify-content:flex-end; opacity:0; transition:opacity 0.12s; }
.task-row:hover .task-actions { opacity:1; }
.icon-btn { width:26px; height:26px; border-radius:5px; border:1px solid var(--border); background:var(--surface); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:13px; transition:all 0.12s; }
.icon-btn:hover { background:var(--bg); }
.icon-btn.btn-delete:hover { color:var(--danger); }

.modal-overlay { display:none; position:fixed; inset:0; background:rgba(26,23,20,0.45); z-index:200; align-items:center; justify-content:center; }
.modal-overlay.open { display:flex; }
.modal { background:var(--surface); border-radius:14px; padding:28px; width:560px; max-width:95vw; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.2); }
.modal-title { font-family:'DM Serif Display',serif; font-size:20px; margin-bottom:22px; }

.form-row { margin-bottom:16px; }
.form-row label { display:block; font-size:12px; font-weight:500; letter-spacing:0.3px; text-transform:uppercase; color:var(--text-muted); margin-bottom:6px; }
.form-row input, .form-row select, .form-row textarea { width:100%; padding:9px 12px; border:1px solid var(--border); border-radius:7px; font-size:13.5px; background:var(--bg); color:var(--text); outline:none; transition:border-color 0.12s; font-family:'DM Sans',sans-serif; }
.form-row input:focus, .form-row select:focus, .form-row textarea:focus { border-color:var(--accent); }
.form-row textarea { min-height:60px; resize:vertical; }
.form-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }

.form-section { margin:20px 0; padding:16px; background:var(--surface2); border-radius:8px; }
.form-section-title { font-size:13px; font-weight:600; margin-bottom:12px; color:var(--text); }

.checkbox-group { display:flex; flex-direction:column; gap:8px; }
.checkbox-item { display:flex; align-items:center; gap:8px; }
.checkbox-item input { width:18px; height:18px; cursor:pointer; }
.checkbox-item label { font-size:13px; cursor:pointer; text-transform:none; font-weight:400; margin:0; }

.checklist-items { display:flex; flex-direction:column; gap:6px; margin-top:8px; }
.checklist-item { display:flex; align-items:center; gap:8px; padding:8px; background:var(--surface); border-radius:6px; }
.checklist-item input[type="text"] { flex:1; border:none; background:transparent; font-size:13px; }
.checklist-remove { color:var(--danger); cursor:pointer; font-size:16px; }

.btn-add-item { padding:6px 12px; background:var(--blue-light); color:var(--blue); border:none; border-radius:6px; font-size:12px; cursor:pointer; margin-top:8px; }

.modal-footer { display:flex; justify-content:flex-end; gap:8px; margin-top:24px; }
.btn-cancel { padding:8px 16px; border-radius:7px; border:1px solid var(--border); background:transparent; font-size:13px; cursor:pointer; color:var(--text-muted); }
.btn-save { padding:8px 20px; border-radius:7px; border:none; background:var(--accent); color:white; font-size:13px; font-weight:500; cursor:pointer; }

.loading { text-align:center; padding:60px; color:var(--text-muted); }
.spinner { width:28px; height:28px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.7s linear infinite; margin:0 auto 12px; }
@keyframes spin { to{transform:rotate(360deg)} }

.toast { position:fixed; bottom:24px; right:24px; background:var(--text); color:white; padding:12px 18px; border-radius:8px; font-size:13px; z-index:300; opacity:0; transform:translateY(8px); transition:all 0.2s; }
.toast.show { opacity:1; transform:translateY(0); }

.comments-section { margin-top:16px; padding-top:16px; border-top:1px solid var(--border); }
.comment { padding:10px; background:var(--surface2); border-radius:6px; margin-bottom:8px; }
.comment-header { display:flex; justify-content:space-between; margin-bottom:4px; }
.comment-author { font-size:12px; font-weight:600; }
.comment-time { font-size:11px; color:var(--text-muted); }
.comment-text { font-size:13px; }
.comment-input { display:flex; gap:8px; margin-top:8px; }
.comment-input input { flex:1; }
.comment-input button { padding:6px 12px; background:var(--accent); color:white; border:none; border-radius:6px; cursor:pointer; }
</style>
</head>
<body>

<header>
  <div class="header-brand">Command Centre</div>
  <div class="header-right">
    <div class="user-selector">
      <select id="user-filter" onchange="setUserFilter()">
        <option value="">View as: Everyone</option>
      </select>
    </div>
    <div class="sync-status">
      <div class="sync-dot" id="sync-dot"></div>
      <span id="sync-label">Connected</span>
    </div>
    <button class="btn-add" onclick="openModal()">+ Add Task</button>
  </div>
</header>

<div class="config-banner" id="config-banner">
  ‚öôÔ∏è <strong>Setup:</strong> Paste your Google Apps Script URL here.
  <input type="text" id="script-url-input" placeholder="https://script.google.com/macros/s/.../exec" />
  <button class="btn-connect" onclick="saveScriptUrl()">Connect</button>
</div>

<main>
  <div class="summary-bar">
    <div class="summary-card">
      <div class="summary-num" id="s-overdue">‚Äî</div>
      <div class="summary-label">Overdue</div>
    </div>
    <div class="summary-card">
      <div class="summary-num" id="s-week">‚Äî</div>
      <div class="summary-label">This Week</div>
    </div>
    <div class="summary-card">
      <div class="summary-num" id="s-available">‚Äî</div>
      <div class="summary-label">Available</div>
    </div>
    <div class="summary-card">
      <div class="summary-num" id="s-done">‚Äî</div>
      <div class="summary-label">Done</div>
    </div>
  </div>

  <div class="filters">
    <div class="filter-chip active" data-dept="all" onclick="setDeptFilter('all',this)">All Departments</div>
  </div>

  <div id="task-container">
    <div class="loading"><div class="spinner"></div>Connect to get started</div>
  </div>
</main>

<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-title" id="modal-title">Add New Task</div>
    
    <div class="form-row">
      <label>Task Name</label>
      <input type="text" id="f-name" placeholder="Task description" />
    </div>

    <div class="form-grid">
      <div class="form-row">
        <label>Department</label>
        <select id="f-dept"></select>
      </div>
      <div class="form-row">
        <label>Priority</label>
        <select id="f-priority"></select>
      </div>
    </div>

    <div class="form-grid">
      <div class="form-row">
        <label>Assignment Type</label>
        <select id="f-assignment-type" onchange="toggleAssignee()">
          <option value="individual">Individual</option>
          <option value="department">Department (anyone)</option>
        </select>
      </div>
      <div class="form-row" id="assignee-row">
        <label>Assigned To</label>
        <select id="f-assignee"></select>
      </div>
    </div>

    <div class="form-grid">
      <div class="form-row">
        <label>Due Date</label>
        <input type="date" id="f-due" />
      </div>
      <div class="form-row">
        <label>Recurrence</label>
        <select id="f-recur">
          <option value="none">No recurrence</option>
          <option value="daily">Every day</option>
          <option value="every-2-days">Every 2 days</option>
          <option value="every-3-days">Every 3 days</option>
          <option value="weekly">Weekly</option>
          <option value="fortnightly">Fortnightly</option>
          <option value="monthly">Monthly</option>
          <option value="quarterly">Quarterly</option>
          <option value="annually">Annually</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <label>Notes (optional)</label>
      <textarea id="f-notes" placeholder="Additional context..."></textarea>
    </div>

    <div class="form-section">
      <div class="form-section-title">Checklist (optional)</div>
      <div class="checklist-items" id="checklist-items"></div>
      <button type="button" class="btn-add-item" onclick="addChecklistItem()">+ Add Item</button>
    </div>

    <div class="form-section">
      <div class="form-section-title">Notifications</div>
      <div class="checkbox-group">
        <div class="checkbox-item">
          <input type="checkbox" id="n-assign-assignee" checked />
          <label for="n-assign-assignee">Notify assignee on assignment</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="n-comment-creator" checked />
          <label for="n-comment-creator">Notify creator on comments</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="n-comment-assignee" checked />
          <label for="n-comment-assignee">Notify assignee on comments</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="n-complete-creator" checked />
          <label for="n-complete-creator">Notify creator on completion</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="n-complete-assignee" checked />
          <label for="n-complete-assignee">Notify assignee on completion</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="n-overdue" checked />
          <label for="n-overdue">Notify when overdue</label>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save" onclick="saveTask()">Save Task</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SCRIPT_URL_KEY = 'commandCentreScriptUrl';
let SCRIPT_URL = localStorage.getItem(SCRIPT_URL_KEY) || '';

let tasks = [];
let team = [];
let departments = [];
let priorities = [];
let currentUser = '';
let currentDept = 'all';
let editingId = null;
let checklistItems = [];

window.onload = () => {
  if (SCRIPT_URL) {
    document.getElementById('config-banner').classList.add('hidden');
    document.getElementById('script-url-input').value = SCRIPT_URL;
    loadData();
  }
};

function saveScriptUrl() {
  const val = document.getElementById('script-url-input').value.trim();
  if (!val.startsWith('https://script.google.com')) {
    alert('Please paste a valid Google Apps Script URL');
    return;
  }
  SCRIPT_URL = val;
  localStorage.setItem(SCRIPT_URL_KEY, SCRIPT_URL);
  document.getElementById('config-banner').classList.add('hidden');
  loadData();
}

function setSyncStatus(state) {
  const dot = document.getElementById('sync-dot');
  const label = document.getElementById('sync-label');
  dot.className = 'sync-dot' + (state === 'syncing' ? ' syncing' : '');
  label.textContent = state === 'syncing' ? 'Syncing...' : 'Connected';
}

async function api(params) {
  setSyncStatus('syncing');
  try {
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify(params)
    });
    const data = await res.json();
    setSyncStatus('ok');
    return data;
  } catch(e) {
    setSyncStatus('error');
    console.error(e);
    return { error: e.message };
  }
}

async function loadData() {
  document.getElementById('task-container').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';
  
  const [tasksRes, teamRes, deptsRes, prioritiesRes] = await Promise.all([
    api({ action: 'getTasks' }),
    api({ action: 'getTeam' }),
    api({ action: 'getDepartments' }),
    api({ action: 'getPriorities' })
  ]);
  
  if (tasksRes.success) tasks = tasksRes.tasks;
  if (teamRes.success) team = teamRes.team;
  if (deptsRes.success) departments = deptsRes.departments;
  if (prioritiesRes.success) priorities = prioritiesRes.priorities;
  
  populateFilters();
  populateUserFilter();
  renderTasks();
  showToast('Data loaded ‚úì');
}

function populateFilters() {
  const filtersDiv = document.querySelector('.filters');
  filtersDiv.innerHTML = '<div class="filter-chip active" data-dept="all" onclick="setDeptFilter(\'all\',this)">All Departments</div>';
  departments.forEach(d => {
    filtersDiv.innerHTML += `<div class="filter-chip" data-dept="${d.id}" onclick="setDeptFilter('${d.id}',this)">${d.name}</div>`;
  });
}

function populateUserFilter() {
  const select = document.getElementById('user-filter');
  select.innerHTML = '<option value="">View as: Everyone</option>';
  team.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = `View as: ${p.name}`;
    select.appendChild(opt);
  });
}

function setUserFilter() {
  currentUser = document.getElementById('user-filter').value;
  renderTasks();
}

function setDeptFilter(deptId, el) {
  currentDept = deptId;
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderTasks();
}

function getFilteredTasks() {
  let f = [...tasks];
  
  if (currentUser) {
    const userDept = team.find(t => t.id === currentUser)?.departmentId;
    f = f.filter(t => {
      if (t.assignmentType === 'individual') return t.assigneeId === currentUser;
      return t.departmentId === userDept;
    });
  }
  
  if (currentDept !== 'all') {
    f = f.filter(t => t.departmentId === currentDept);
  }
  
  return f;
}

function renderTasks() {
  const container = document.getElementById('task-container');
  const filtered = getFilteredTasks();

  if (filtered.length === 0) {
    container.innerHTML = '<div class="loading">No tasks</div>';
    updateCounts();
    return;
  }

  container.innerHTML = filtered.map(t => {
    const priority = getPriorityById(t.priorityId);
    const assignee = getTeamById(t.assigneeId);
    const dept = getDeptById(t.departmentId);
    const dueClass = daysFromNow(t.due) < 0 ? 'overdue' : '';
    
    const checklistProgress = t.checklist ? calculateChecklistProgress(t.checklist, t.checklistCompleted) : '';
    const lastComment = ''; // TODO: get last comment
    
    return `<div class="task-row ${t.status==='done'?'done':''}">
      <div class="task-check ${t.status==='done'?'checked':''}" onclick="toggleDone('${t.id}',event)">${t.status==='done'?'‚úì':''}</div>
      <div>${priority ? `<span class="priority-badge priority-${priority.id}">${priority.id}</span>` : ''}</div>
      <div class="task-content">
        <div class="task-name">${t.name}</div>
        <div class="task-meta">
          ${checklistProgress ? `<span class="task-meta-item">‚úì ${checklistProgress}</span>` : ''}
          ${lastComment ? `<span class="task-meta-item">üí¨ ${lastComment}</span>` : ''}
        </div>
      </div>
      <div class="task-assignee">${assignee ? assignee.name : 'Unassigned'}</div>
      <div class="task-dept">${dept ? dept.name : ''}</div>
      <div class="task-due ${dueClass}">${formatDate(t.due)}</div>
    </div>`;
  }).join('');

  updateCounts();
}

function calculateChecklistProgress(checklistJson, completedJson) {
  try {
    const items = JSON.parse(checklistJson || '[]');
    const completed = JSON.parse(completedJson || '[]');
    if (items.length === 0) return '';
    return `${completed.length}/${items.length}`;
  } catch(e) {
    return '';
  }
}

function updateCounts() {
  const overdue = tasks.filter(t => t.status !== 'done' && daysFromNow(t.due) < 0).length;
  const week = tasks.filter(t => t.status !== 'done' && daysFromNow(t.due) >= 0 && daysFromNow(t.due) <= 7).length;
  const available = tasks.filter(t => t.assignmentType === 'department' && !t.pickedUpById && t.status !== 'done').length;
  const done = tasks.filter(t => t.status === 'done').length;
  
  document.getElementById('s-overdue').textContent = overdue;
  document.getElementById('s-week').textContent = week;
  document.getElementById('s-available').textContent = available;
  document.getElementById('s-done').textContent = done;
}

function daysFromNow(dateStr) {
  const today = new Date(); today.setHours(0,0,0,0);
  const d = new Date(dateStr); d.setHours(0,0,0,0);
  return Math.round((d - today) / 86400000);
}

function formatDate(dateStr) {
  const diff = daysFromNow(dateStr);
  if (diff === 0) return 'Today';
  if (diff === 1) return 'Tomorrow';
  if (diff === -1) return 'Yesterday';
  if (diff < 0) return `${Math.abs(diff)}d overdue`;
  if (diff <= 7) return `In ${diff} days`;
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
}

function getTeamById(id) { return team.find(t => t.id === id); }
function getDeptById(id) { return departments.find(d => d.id === id); }
function getPriorityById(id) { return priorities.find(p => p.id === id); }

async function toggleDone(id, e) {
  e.stopPropagation();
  const task = tasks.find(t => t.id === id);
  if (!task) return;
  
  const newStatus = task.status === 'done' ? 'pending' : 'done';
  await api({ action: 'updateTask', id: task.id, status: newStatus, completedBy: currentUser || 'User' });
  await loadData();
}

function openModal() {
  editingId = null;
  document.getElementById('modal-title').textContent = 'Add New Task';
  document.getElementById('f-name').value = '';
  document.getElementById('f-notes').value = '';
  document.getElementById('f-assignment-type').value = 'individual';
  
  const deptSelect = document.getElementById('f-dept');
  deptSelect.innerHTML = departments.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
  
  const prioritySelect = document.getElementById('f-priority');
  prioritySelect.innerHTML = priorities.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
  
  const assigneeSelect = document.getElementById('f-assignee');
  assigneeSelect.innerHTML = '<option value="">Select...</option>' + team.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
  
  const d = new Date(); d.setDate(d.getDate() + 7);
  document.getElementById('f-due').value = d.toISOString().split('T')[0];
  document.getElementById('f-recur').value = 'none';
  
  checklistItems = [];
  renderChecklistItems();
  
  toggleAssignee();
  
  document.getElementById('modal').classList.add('open');
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
}

function toggleAssignee() {
  const type = document.getElementById('f-assignment-type').value;
  document.getElementById('assignee-row').style.display = type === 'individual' ? 'block' : 'none';
}

function addChecklistItem() {
  checklistItems.push({ text: '', checked: false });
  renderChecklistItems();
}

function renderChecklistItems() {
  const container = document.getElementById('checklist-items');
  if (checklistItems.length === 0) {
    container.innerHTML = '<div style="font-size:12px;color:var(--text-muted)">No checklist items</div>';
    return;
  }
  container.innerHTML = checklistItems.map((item, i) => `
    <div class="checklist-item">
      <input type="text" value="${item.text}" onchange="checklistItems[${i}].text=this.value" placeholder="Checklist item..." />
      <span class="checklist-remove" onclick="removeChecklistItem(${i})">√ó</span>
    </div>
  `).join('');
}

function removeChecklistItem(idx) {
  checklistItems.splice(idx, 1);
  renderChecklistItems();
}

async function saveTask() {
  const name = document.getElementById('f-name').value.trim();
  if (!name) { alert('Please enter a task name'); return; }
  
  const assignmentType = document.getElementById('f-assignment-type').value;
  const assigneeId = assignmentType === 'individual' ? document.getElementById('f-assignee').value : '';
  
  const data = {
    name,
    departmentId: document.getElementById('f-dept').value,
    priorityId: document.getElementById('f-priority').value,
    assignmentType,
    assigneeId,
    assignedById: currentUser || 'ADMIN',
    due: document.getElementById('f-due').value,
    recurrence: document.getElementById('f-recur').value,
    notes: document.getElementById('f-notes').value.trim(),
    checklist: JSON.stringify(checklistItems.map(i => i.text).filter(t => t)),
    notifyAssigneeOnAssign: document.getElementById('n-assign-assignee').checked,
    notifyCreatorOnComment: document.getElementById('n-comment-creator').checked,
    notifyAssigneeOnComment: document.getElementById('n-comment-assignee').checked,
    notifyCreatorOnComplete: document.getElementById('n-complete-creator').checked,
    notifyAssigneeOnComplete: document.getElementById('n-complete-assignee').checked,
    notifyOnOverdue: document.getElementById('n-overdue').checked,
  };
  
  closeModal();
  
  if (editingId) {
    await api({ action: 'updateTask', id: editingId, ...data });
    showToast('Task updated ‚úì');
  } else {
    await api({ action: 'addTask', ...data });
    showToast('Task created ‚úì');
  }
  
  await loadData();
}

document.getElementById('modal').addEventListener('click', function(e) {
  if(e.target === this) closeModal();
});

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

setInterval(() => { if (SCRIPT_URL) loadData(); }, 60000);
</script>
</body>
</html>
